var AJAX_GAZ="http://"+DOMAIN+"/ajax/gazeta.php?"+VALUES,clientAdd=function(a){function c(){var c={op:"client_add",person:$("#cperson").val(),fio:$("#fio").val(),telefon:$("#ctelefon").val(),org_name:$("#org_name").val(),adres:$("#cadres").val(),inn:$("#inn").val(),kpp:$("#kpp").val(),email:$("#email").val(),skidka:$("#cskidka").val()};0==c.person?b("Не выбрана категория",-48):c.fio||c.org_name?(e.process(),$.post(AJAX_GAZ,c,function(b){b.success?(e.close(),_msg("Новый клиент внесён."),"function"==
typeof a?a(b):document.location.href=URL+"&p=gazeta&d=client&d1=info&id="+b.uid):e.abort()},"json")):b("Необходимо указать контактное лицо<br />либо название организации",-61)}function b(a,b){e.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",top:b,left:131,indent:40,show:1,remove:1})}var d='<table class="client-add"><tr><td class="label">Категория:<td><input type="hidden" id="cperson"><a href="'+URL+'&p=gazeta&d=setup&d1=person" class="img_edit'+_tooltip("Настройка категорий клиентов",-95)+'</a><tr><td class="label">Контактное лицо (фио):<td><input type="text" id="fio" maxlength="200"><tr><td class="label">Название организации:<td><input type="text" id="org_name" maxlength="200"><tr><td class="label">Телефоны:<td><input type="text" id="ctelefon" maxlength="300"><tr><td class="label">Адрес:<td><input type="text" id="cadres" maxlength="200"><tr><td class="label">ИНН:<td><input type="text" id="inn" maxlength="100"><tr><td class="label">КПП:<td><input type="text" id="kpp" maxlength="100"><tr><td class="label">E-mail:<td><input type="text" id="email" maxlength="100"><tr><td class="label">Скидка:<td><input type="hidden" id="cskidka"></table>',
e=_dialog({top:40,width:440,head:"Добавление нoвого клиента",content:d,submit:c});$("#cperson")._select({width:180,title0:"Не выбрана",spisok:PERSON_SPISOK});$("#cskidka")._select({width:60,title0:"Нет",spisok:SKIDKA_SPISOK});$("#fio").focus();$("#fio,#org_name,#ctelefon,#cadres,#inn,#kpp,#email").keyEnter(c)},clientFilter=function(){var a={fast:cFind.inp(),person:$("#person").val(),order:$("#order").val(),skidka:$("#skidka").val(),dolg:$("#dolg").val()};$(".filter")[a.fast?"hide":"show"]();return a},
clientSpisokLoad=function(){var a=clientFilter(),c=$(".result");a.op="client_spisok";c.hasClass("busy")||(c.addClass("busy"),$.post(AJAX_GAZ,a,function(a){c.removeClass("busy");a.success&&(c.html(a.result),$(".left").html(a.spisok))},"json"))},zayavFilter=function(){return{op:"zayav_spisok",find:$("#fz-find").val(),client_id:$("#fz-client_id").val(),cat:$("#fz-cat").val(),gnyear:$("#fz-gnyear").val(),nomer:$("#fz-nomer").val(),nopublic:$("#fz-nopublic").val()}},zayavSpisok=function(a,c){var b=zayavFilter();
b[c]=a;"gnyear"==c&&($("#nomer")._select(0),b.nomer=0);$(".filter")[b.find?"hide":"show"]();$("#mainLinks").hasClass("busy")||($("#mainLinks").addClass("busy"),$.post(AJAX_GAZ,b,function(b){$("#mainLinks").removeClass("busy");b.success&&($(".result").html(b.result),$(".left").html(b.spisok),"change"==a&&$("#nomer")._select({width:147,title0:"Номер не указан",spisok:b.gn_sel,func:zayavSpisok}))},"json"))},zayavRubric=function(){$("#rubric_id")._select({width:120,title0:"Не указана",spisok:RUBRIC_SPISOK,
func:function(a){$("#rubric_sub_id").val(0)._select("remove");zayavRubricSub(a)}})},zayavRubricSub=function(a){RUBRIC_SUB_SPISOK[a]&&$("#rubric_sub_id")._select({width:180,title0:"Подрубрика не указана",spisok:RUBRIC_SUB_SPISOK[a]})},zayavObSumCalc=function(){var a=0,c="",b=$("#ztxt").val().replace(/\./g,"").replace(/,/g,"").replace(/\//g,"").replace(/\"/g,"").replace(/( +)/g," ").replace(/^\s+/g,"").replace(/\s+$/g,"");if(b.length){a+=1*TXT_CENA_FIRST;if(b.length>TXT_LEN_FIRST){var c=" = ",d=Math.ceil((b.length-
TXT_LEN_FIRST)/TXT_LEN_NEXT),c=c+TXT_LEN_FIRST,e=b.length-TXT_LEN_FIRST-(d-1)*TXT_LEN_NEXT,a=a+d*TXT_CENA_NEXT;TXT_LEN_NEXT==e&&d++;1<d&&(c+=" + "+TXT_LEN_NEXT);2<d&&(c+="x"+(d-1));TXT_LEN_NEXT>e&&(c+=" + "+e)}c="Длина: <b>"+b.length+"</b>"+c+"<br />Цена: <b>"+a+"</b> руб.<span>(без учёта доп. параметров)</span>";$("#txt-count").html(c)}else $("#txt-count").html("");window.gnGet.cena(a);"0"==$("#summa_manual").val()&&$("#summa").val(window.gnGet.summa())},zayavRekSumCalc=function(){var a=$(this),
c=a.val(),b=a.attr("id"),d=$("#size_x").val(),e=$("#size_y").val(),d=REGEXP_CENA.test(d)?d.replace(",","."):0,e=REGEXP_CENA.test(e)?e.replace(",","."):0,k=0;$("#kv_sm").val("");REGEXP_CENA.test(c)?(a.prev().remove(".hint"),(k=Math.round(d*e))&&$("#kv_sm").val(k)):a.vkHint({msg:'<span class="red">Не корректно введено значение.</span>',remove:1,indent:40,show:1,top:"size_x"==b?-57:-79,left:"size_x"==b?-33:20});window.gnGet.cena(k);"0"==$("#summa_manual").val()&&$("#summa").val(window.gnGet.summa());
$("#skidka-txt").html(window.gnGet.skidka())},incomeSpisok=function(){var a={op:"income_spisok",day:$(".selected").val(),income_id:$("#income_id").val(),worker_id:$("#worker_id").val()};$(".inc-path").addClass("_busy");$.post(AJAX_GAZ,a,function(a){$(".inc-path").removeClass("_busy");a.success&&($(".inc-path").html(a.path),$("#spisok").html(a.html))},"json")},expenseFilter=function(){for(var a=[],c=$("#monthList input"),b=1;12>=b;b++)1==c.eq(b-1).val()&&a.push(b);return{op:"expense_spisok",category:$("#category").val(),
worker:$("#worker").val(),invoice_id:$("#invoice_id").val(),year:$("#year").val(),month:a.join()}},expenseSpisok=function(){$("#mainLinks").addClass("busy");$.post(AJAX_GAZ,expenseFilter(),function(a){$("#mainLinks").removeClass("busy");a.success&&($("#spisok").html(a.html),$("#monthList").html(a.mon))},"json")};
$.fn.clientSel=function(a){function c(c){c={op:"client_sel",val:c||"",client_id:a.client_id};b._select("process");$.post(AJAX_GAZ,c,function(c){b._select("cancel");c.success&&(b._select(c.spisok),a.client_id&&(b._select(a.client_id),a.client_id=0))},"json")}var b=$(this);a=$.extend({width:270,add:null,client_id:b.val()||0,func:function(){}},a);a.add&&(a.add=function(){clientAdd(function(a){var c=[];c.push(a);b._select(c);b._select(a.uid)})});b._select({width:a.width,title0:"Начните вводить данные клиента...",
spisok:[],write:1,nofind:"Клиентов не найдено",func:a.func,funcAdd:a.add,funcKeyup:c});c();return b};
$.fn.gnGet=function(a){function c(b,c){b&&(t=GN_FIRST_ACTIVE,q=t+(c||0)+a.show);l.find("#darr").remove();var e="";for(f=t;f<q&&!(f>GN_LAST_ACTIVE);f++){var r=GN[f];r?e+='<table><tr><td><table class="gns-week'+(r.sel?" gnsel":"")+(r.prev?" prev":"")+'" val="'+f+'"><tr><td class="td"><b>'+r.week+'</b><span class="g">('+f+')</span><td class="td"><span class="g">выход</span> '+r.txt+'<td class="cena" id="cena'+f+'"></table><td class="vdop"><input type="hidden" id="vdop'+f+'" value="'+r.dop+'" /></table>':
end++}e+=q<GN_LAST_ACTIVE?'<div id="darr">&darr; &darr; &darr;</div>':"";w[b?"html":"append"](e);w.animate({height:w.find(".gns-week").length*z+"px"},300);b&&3>a.category&&d(function(b){$("#vdop"+b.n)._dropdown({title0:1==a.category?"Доп. параметр не указан":"Полоса не указана",spisok:1==a.category?OBDOP_SPISOK:POLOSA_SPISOK,func:function(c){GN[b.n].dop=c;g();a.func()}})});g()}function b(){A._dropdown(2<a.category?"remove":{head:"Установить всем...",headgrey:1,title0:1==a.category?"Доп. параметр не указан":
"Полоса не указана",nosel:1,spisok:1==a.category?OBDOP_SPISOK:POLOSA_SPISOK,func:function(b){d(function(a){a.prev||($("#vdop"+a.n)._dropdown(b),a.dop=b)});g();a.func()}})}function d(a,b){for(f=GN_FIRST_ACTIVE;f<=GN_LAST_ACTIVE;f++){var c=GN[f];c&&(b||c.sel)&&a(c,f)}}function e(){var b=0;d(function(){b++});if(b){var e="Выбран"+_end(b,["","о"])+" "+b+" номер"+_end(b,["","a","ов"])+"<a>очистить</a>";x.html(e).find("a").click(function(){k();c(1);x.html("");u.removeClass("sel");a.func()})}else x.html("")}
function k(){d(function(a,b){a.n=b;a.sel=0;a.prev=0;a.cena=0;a.dop=0},1)}function g(){var b=0,c=0;switch(a.category){case 1:var e=0;a.manual&&(d(function(a){a.prev||(e++,4==e?e=0:c++)}),e=0,b=Math.round(s/c*1E6)/1E6);d(function(c){c.prev||(e++,4==e?(e=0,c.cena=0):c.cena=a.manual?b:v?v+(c.dop?OBDOP_CENA_ASS[c.dop]:0):0);l.find("#cena"+c.n).html(Math.round(100*c.cena)/100)});break;case 2:a.manual&&(d(function(a){0<a.dop&&!a.prev&&c++}),b=Math.round(s/c*1E6)/1E6);m=0;d(function(c){if(!c.prev&&(c.cena=
0,c.dop))if(a.manual)c.cena=b;else{c.cena=v*POLOSA_CENA_ASS[c.dop];var d=c.cena*a.skidka/100;c.cena-=d;m+=d}l.find("#cena"+c.n).html(Math.round(100*c.cena)/100)});m=Math.round(100*m)/100;break;default:d(function(a){a.prev||c++}),b=Math.round(s/c*1E6)/1E6,d(function(a){a.prev||(a.cena=b);l.find("#cena"+a.n).html(Math.round(100*a.cena)/100)})}}function y(){var a=0;d(function(b){b.prev||(a+=b.cena)});return Math.round(100*a)/100}a=$.extend({show:4,add:8,category:1,gns:null,skidka:0,manual:0,func:function(){}},
a);var h=$(this),f,z=21,t=GN_FIRST_ACTIVE,q=t+a.show;h.html('<div id="gnGet"><table><tr><td><div id="dopLinks"><a class="link" val="4">Месяц</a><a class="link" val="13">3 месяца</a><a class="link" val="26">Полгода</a><a class="link" val="52">Год</a></div><td><input type="hidden" id="dopDef"></table><table class="gn-spisok"><tr><td id="selCount"><td><div id="gns"></div></table></div>');$(document).on("click","#darr",function(){t=q;q+=a.add;c()}).on("click",".gns-week",function(){u.removeClass("sel");
var b=$(this),c=!b.hasClass("gnsel"),d=b.attr("val");b[(c?"add":"remove")+"Class"]("gnsel");b.removeClass("prev");GN[d].prev=0;GN[d].sel=c;GN[d].dop=0;3>a.category&&$("#vdop"+d).val(0)._dropdown(c?{title0:1==a.category?"Доп. параметр не указан":"Полоса не указана",spisok:1==a.category?OBDOP_SPISOK:POLOSA_SPISOK,func:function(b){GN[d].dop=b;g();a.func()}}:"remove");e();g();a.func()});var l=$("#gnGet"),w=l.find("#gns"),u=l.find("#dopLinks a"),A=l.find("#dopDef"),x=l.find("#selCount"),v=0,s=0,m=0;k();
if(a.gns){var p=0;for(f in a.gns){if(f>GN_LAST_ACTIVE)break;GN[f]&&(p=GN[f],p.sel=1,p.prev=1,p.cena=a.gns[f][0],p.dop=a.gns[f][1],p=f)}c(1,p-GN_FIRST_ACTIVE+1);e()}else c();b();u.click(function(){var b=$(this),d=1*b.attr("val");k();if(b.hasClass("sel"))d=0,b.removeClass("sel");else for(u.removeClass("sel"),b.addClass("sel"),f=GN_FIRST_ACTIVE,b=d;b&&!(f>GN_LAST_ACTIVE);)GN[f]&&(GN[f].sel=1,b--,f++);e();c(1,d);a.func()});h.cena=function(a){v=a||0;g()};h.skidka=function(b){return void 0!=b?(a.skidka=
b,g(),""):2==a.category&&m?"Сумма скидки: <b>"+m+"</b> руб.":""};h.summa=y;h.clear=function(d){a.category=d;a.manual=0;s=m=a.skidka=0;u.removeClass("sel");k();c(1);b()};h.manual=function(b,c){a.manual=b;s=y();g();a.func()};h.manualSumma=function(a){s=REGEXP_CENA.test(a)?1*a.replace(",","."):0;g()};h.result=function(){var b=[],c=0;d(function(d){2!=a.category||d.dop||(c=1);b.push(d.n+":"+d.cena+":"+d.dop)});return c?"no_polosa":b.join()};return h};
$(document).on("click","#client ._next",function(){if(!$(this).hasClass("busy")){var a=$(this),c=clientFilter();c.op="client_next";c.page=a.attr("val");a.addClass("busy");$.post(AJAX_GAZ,c,function(b){b.success?(a.remove(),$("#client .left").append(b.spisok)):a.removeClass("busy")},"json")}}).on("click",".zayav_next",function(){var a=$(this),c=zayavFilter();c.page=a.attr("val");a.hasClass("busy")||(a.addClass("busy"),$.post(AJAX_GAZ,c,function(b){b.success?a.after(b.spisok).remove():a.removeClass("busy")},
"json"))}).on("click",".income-add",function(){function a(){var a={op:"income_add",from:OPL.from,income_id:$("#income_id_add").val(),sum:$("#sum").val(),zayav_id:OPL.zayav_id||0,client_id:OPL.client_id||0,prim:$.trim($("#prim").val())};0==a.income_id?c("Не указан вид платежа"):REGEXP_CENA.test(a.sum)&&0!=a.sum?a.zayav_id||a.prim?(d.process(),$.post(AJAX_GAZ,a,function(a){if(a.success)switch(d.close(),_msg("Платёж успешно внесён!"),OPL.from){case "client":$("#income_spisok").html(a.html);$(".left:first").html(a.balans);
break;case "zayav":$("#income_spisok").html(a.html);$(".zdel").remove();break;case "income":incomeSpisok()}else d.abort()},"json")):(c("Необходимо указать комментарий"),$("#prim").focus()):(c("Некорректно указана сумма."),$("#sum").focus())}function c(a){d.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",remove:1,indent:40,show:1,top:-48,left:115})}var b='<table class="income-add-tab">'+(OPL.client_fio?'<tr><td class="label">Клиент:<td>'+OPL.client_fio:"")+(OPL.zayav_name?'<tr><td class="label">Заявка:<td><b>'+
OPL.zayav_name+"</b>":"")+'<tr><td class="label">Вид платежа:<td><input type="hidden" id="income_id_add"><a href="'+URL+'&p=gazeta&d=setup&d1=money" class="img_edit'+_tooltip("Настройка видов платежей",-85)+'</a><tr><td class="label">Сумма:<td><input type="text" id="sum" class="money" maxlength="11"> руб.<tr><td class="label">Комментарий:<td><input type="text" id="prim" maxlength="100"></table>',d=_dialog({width:400,head:"Внесение платежа",content:b,submit:a});$("#sum").focus();$("#sum,#prim").keyEnter(a);
$("#income_id_add")._select({width:180,title0:"Не указан",spisok:INCOME_SPISOK,func:function(a){$("#sum").focus()}})}).on("click",".income-del",function(){for(var a=$(this),c=_dialog({width:300,head:"Удаление платежа",content:"<center><b>Подтвердите удаление платежа.</b></center>",butSubmit:"Удалить",submit:function(){var b={op:"income_del",id:a.attr("val")};c.process();$.post(AJAX_GAZ,b,function(b){b.success?(a.remove(),c.close(),_msg("Платёж удалён")):c.abort()},"json")}});"TR"!=a[0].tagName;)a=
a.parent()}).on("click","#income_next",function(){var a=$(this),c={op:"income_spisok",page:$(this).attr("val"),limit:$("#money_limit").val(),client_id:$("#money_client_id").val(),zayav_id:$("#money_zayav_id").val(),deleted:$("#money_deleted").val(),income_id:$("#money_income_id").val(),worker_id:$("#money_worker_id").val(),day:$(".selected").val()||""};a.hasClass("busy")||(a.addClass("busy"),$.post(AJAX_GAZ,c,function(b){b.success?a.after(b.html).remove():a.removeClass("busy")},"json"))}).on("click",
".expense #monthList div",expenseSpisok).on("click",".expense ._next",function(){var a=$(this),c=expenseFilter();c.page=a.attr("val");a.hasClass("busy")||(a.addClass("busy"),$.post(AJAX_GAZ,c,function(b){b.success?a.after(b.html).remove():a.removeClass("busy")},"json"))}).on("click",".expense .img_del",function(){for(var a=$(this),c=_dialog({width:300,head:"Удаление расхода",content:"<center><b>Подтвердите удаление расхода.</b></center>",butSubmit:"Удалить",submit:function(){var b={op:"expense_del",
id:a.attr("val")};c.process();$.post(AJAX_GAZ,b,function(b){b.success?(a.remove(),c.close(),_msg("Расход удалён")):c.abort()},"json")}});"TR"!=a[0].tagName;)a=a.parent()}).on("click",".invoice_set",function(){function a(){var a={op:"invoice_set",invoice_id:c,sum:$("#sum").val()};REGEXP_CENA.test(a.sum)?(b.process(),$.post(AJAX_GAZ,a,function(a){a.success?($("#invoice-spisok").html(a.i),b.close(),_msg("Баланс установлен.")):b.abort()},"json")):(b.bottom.vkHint({msg:'<SPAN class="red">Некорректно указана сумма</SPAN>',
remove:1,indent:40,show:1,top:-48,left:72}),$("#sum").focus())}var c=$(this).attr("val"),b=_dialog({width:320,head:"Установка текущей суммы счёта",content:'<table class="_dialog-tab"><tr><td class="label">Сумма:<td><input type="text" class="money" id="sum" maxlength="11"> руб.</table>',butSubmit:"Установить",submit:a});$("#sum").focus().keyEnter(a)}).on("click","#report.invoice .img_note",function(){var a=_dialog({top:20,width:570,head:"История операций со счётом",load:1,butSubmit:"",butCancel:"Закрыть"}),
c={op:"invoice_history",invoice_id:$(this).attr("val")};$.post(AJAX_GAZ,c,function(b){b.success?a.content.html(b.html):a.loadError()},"json")}).on("click","#history_next",function(){if(!$(this).hasClass("busy")){var a=$(this),c={op:"history_next",page:a.attr("val")};a.addClass("busy");$.post(AJAX_GAZ,c,function(b){b.success?a.after(b.html).remove():a.removeClass("busy")},"json")}}).ready(function(){$("#client").length&&(window.cFind=$("#find")._search({width:602,focus:1,enter:1,txt:"Введите данные клиента и нажмите Enter",
func:clientSpisokLoad}),$("#buttonCreate").click(clientAdd),$("#order")._radio({light:1,spisok:[{uid:1,title:"По дате добавления"},{uid:2,title:"По активности"}],func:clientSpisokLoad}),$("#order_radio").vkHint({width:210,msg:'<div style="text-align:justify"><b>По дате добавления:</b><br> клиенты, добавленные последними, стоят в списке первыми.<br><br><b>По активности:</b><br> сортировка по дате выхода последней заявки клиента. Также показывается дополнительное поле "Активность", в котором содержится дата последнего выхода заявки.</div>',
ugol:"right",indent:15,top:-34,left:-246,delayShow:1E3}),$("#person")._select({spisok:PERSON_SPISOK,title0:"Категория не выбрана",func:clientSpisokLoad}),$("#skidka")._select({spisok:SKIDKA_SPISOK,title0:"Скидка не выбрана",func:clientSpisokLoad}),$("#dolg")._check(clientSpisokLoad),$("#dolg_check").vkHint({msg:"<b>Список должников.</b><br /><br />Выводятся клиенты, у которых баланс менее 0. Также в результате отображается общая сумма долга.",ugol:"right",width:150,top:-6,left:-185,indent:20,delayShow:1E3,
correct:0}));$("#clientInfo").length&&($(".cedit").click(function(){function a(){var a={op:"client_edit",id:CLIENT.id,person:$("#cperson").val(),fio:$("#fio").val(),telefon:$("#telefon").val(),org_name:$("#org_name").val(),adres:$("#adres").val(),inn:$("#inn").val(),kpp:$("#kpp").val(),email:$("#email").val(),skidka:$("#cskidka").val()};a.fio||a.org_name?(b.process(),$.post(AJAX_GAZ,a,function(a){a.success?(CLIENT=a,$("#clientInfo .left:first").html(a.html),b.close(),_msg("Данные изменены.")):b.abort()},
"json")):b.bottom.vkHint({msg:'<SPAN class="red">Необходимо указать контактное лицо<br />либо название организации</SPAN>',top:-61,left:131,indent:40,show:1,remove:1})}var c='<table class="client-add"><tr><td class="label">Категория:<td><input type="hidden" id="cperson" value="'+CLIENT.person+'" /><a href="'+URL+'&p=gazeta&d=setup&d1=person" class="img_edit'+_tooltip("Настройка категорий клиентов",-95)+'</a><tr><td class="label">Контактное лицо (фио):<td><input type="text" id="fio" maxlength="200" value="'+
CLIENT.fio+'" /><tr><td class="label">Название организации:<td><input type="text" id="org_name" maxlength="200" value="'+CLIENT.org_name+'" /><tr><td class="label">Телефоны:<td><input type="text" id="telefon" maxlength="300" value="'+CLIENT.telefon+'" /><tr><td class="label">Адрес:<td><input type="text" id="adres" maxlength="200" value="'+CLIENT.adres+'" /><tr><td class="label">ИНН:<td><input type="text" id="inn" maxlength="100" value="'+CLIENT.inn+'" /><tr><td class="label">КПП:<td><input type="text" id="kpp" maxlength="100" value="'+
CLIENT.kpp+'" /><tr><td class="label">E-mail:<td><input type="text" id="email" maxlength="100" value="'+CLIENT.email+'" /><tr><td class="label">Скидка:<td><input type="hidden" id="cskidka" value="'+CLIENT.skidka+'" /></table>',b=_dialog({top:40,width:440,head:"Редактирование данных клиента",content:c,butSubmit:"Сохранить",submit:a});$("#cperson")._select({width:180,spisok:PERSON_SPISOK});$("#cskidka")._select({width:60,title0:"Нет",spisok:SKIDKA_SPISOK});$("#fio").focus();$("#fio,#org_name,#telefon,#adres,#inn,#kpp,#email").keyEnter(a)}),
$(".rightLink .off").vkHint({width:130,msg:"Клиента можно удалить, если у него нет ни одной заявки",ugol:"right",delayShow:700,top:-17,left:-164}),$(".cdel").click(function(){var a=_dialog({top:90,width:300,head:"Удаление клиента",content:"<center>Внимание!<br />Будут удалены все данные о клиенте,<br />его платежи и заметки.<br /><b>Подтвердите удаление.</b></center>",butSubmit:"Удалить",submit:function(){var c={op:"client_del",id:CLIENT.id};a.process();$.post(AJAX_GAZ,c,function(b){b.success?(a.close(),
_msg("Клиент удален."),ADMIN?location.reload():location.href=URL+"&p=gazeta&d=client"):a.abort()},"json")}})}),$("#dopLinks .link").click(function(){$("#dopLinks .link").removeClass("sel");$(this).addClass("sel");var a=$(this).attr("val");$("#zayav_spisok").css("display","zayav"==a?"block":"none");$("#income_spisok").css("display","inc"==a?"block":"none");$("#notes").css("display","note"==a?"block":"none");$("#histories").css("display","hist"==a?"block":"none")}));$("#zayav").length&&($("#find").vkHint({width:145,
msg:'<div style="text-align:justify">Введите значение и нажмите <b>Enter</b>. Поиск производится по всем объявлениям, то есть другие параметры не учитываются. Если указано число и оно совпадает с номером заявки, то эта заявка выводится первая в списке.<div>',ugol:"right",indent:10,top:-1,left:-182,delayShow:1500})._search({width:148,focus:1,enter:1,txt:"Быстрый поиск..",func:zayavSpisok}),$("#cat").rightLink(zayavSpisok),$(".img_word").click(function(){var a=$("#nomer").val();0==a?$(this).vkHint({width:150,
ugol:"right",msg:"<span class=red>Не выбран номер газеты.</span>",indent:5,top:-26,left:-198,show:1,remove:1}):location.href="http://"+DOMAIN+"/view/ob-word.php?"+VALUES+"&gn="+a;return!1}).vkHint({ugol:"right",width:145,msg:'<span style="color:#444">Открыть список объявлений в газетном варианте в формате Microsoft Word.</span>',indent:10,top:-30,left:-193}),$("#nopublic")._check(function(a,c){$(".filter_nomer").toggle();zayavSpisok(a,c)}),$("#nopublic_check").vkHint({width:145,msg:"Заявки, которые не публиковались ни в одном номере газеты.",
indent:60,top:-64,left:-61}),$("#gnyear").years({func:zayavSpisok}),$("#nomer")._select({title0:"Номер не указан",spisok:GN_SEL,func:zayavSpisok}));$("#zayav-add").length&&($("#client_id").clientSel({add:1}),$("#category")._select({width:120,spisok:CATEGORY_SPISOK,func:function(a){$(".ob").addClass("dn");$("#rubric_id").val(0)._select("remove");$("#rubric_sub_id").val(0)._select("remove");$("#ztxt").val("");zayavObSumCalc();$("#telefon").val("");$("#adres").val("");$("#summa_manual")._check(0);$(".rek").addClass("dn");
$("#size_x").val("");$("#size_y").val("");$("#kv_sm").val("");$(".skd").addClass("dn");$("#skidka")._select(0);$(".manual").addClass("dn");$("#summa").attr("readonly",!0).val(0);window.gnGet.clear(a);switch(a){case 1:$(".ob").removeClass("dn");$(".manual").removeClass("dn");zayavRubric();break;case 2:$(".rek").removeClass("dn");$(".skd").removeClass("dn");$(".manual").removeClass("dn");break;default:$("#summa").attr("readonly",!1)}}}),zayavRubric(),$("#ztxt").autosize().focus().keyup(zayavObSumCalc),
$("#size_x").keyup(zayavRekSumCalc),$("#size_y").keyup(zayavRekSumCalc),window.gnGet=$("#gn_spisok").gnGet({func:function(){$("#summa").attr("readonly")&&($("#summa").val(window.gnGet.summa()),$("#skidka-txt").html(window.gnGet.skidka()))}}),$("#skidka")._select({width:60,title0:"Нет",spisok:SKIDKA_SPISOK,func:function(a){window.gnGet.skidka(a);"0"==$("#summa_manual").val()&&$("#summa").val(window.gnGet.summa());$("#skidka-txt").html(window.gnGet.skidka())}}),$("#summa_manual")._check(function(a){$("#summa").attr("readonly",
!a).focus();window.gnGet.manual(a);$("#skidka-txt").html(window.gnGet.skidka())}),$("#summa").keyup(function(){window.gnGet.manualSumma($(this).val())}),$("#note").autosize(),$(".vkButton").click(function(){function a(a){c.vkHint({msg:"<SPAN class=red>"+a+"</SPAN>",remove:1,indent:40,show:1,top:-58,left:-14})}var c=$(this),b={op:"zayav_add",client_id:$("#client_id").val(),category:$("#category").val(),rubric_id:$("#rubric_id").val(),rubric_sub_id:$("#rubric_sub_id").val(),txt:$("#ztxt").val(),telefon:$("#telefon").val(),
adres:$("#adres").val(),size_x:$("#size_x").val(),size_y:$("#size_y").val(),gns:window.gnGet.result(),skidka:$("#skidka").val(),summa_manual:$("#summa_manual").val(),note:$("#note").val()};1==b.category&&0==b.rubric_id?a("Не указана рубрика"):1!=b.category||b.txt?1!=b.category||b.telefon||b.adres?2==b.category&&0==b.client_id?a("Не выбран клиент"):2!=b.category||REGEXP_CENA.test(b.size_x)&&REGEXP_CENA.test(b.size_y)?b.gns?"no_polosa"==b.gns?a("Необходимо указать полосы у всех номеров"):REGEXP_CENA.test($("#summa").val())?
(c.addClass("busy"),$.post(AJAX_GAZ,b,function(a){a.success?(_msg("Заявка внесена."),location.href=URL+"&p=gazeta&d=zayav&d1=info&id="+a.id):c.removeClass("busy")},"json")):(a("Некорректно введена итоговая стоимость"),$("#summa").focus()):a("Нужно выбрать хотя бы один номер выпуска"):a("Некорректно указан размер блока"):(a("Укажите контактный телефон или адрес клиента"),$("#telefon").focus()):(a("Введите текст объявления"),$("#ztxt").focus())}),$(".vkCancel").click(function(){location.href=URL+"&p=gazeta&d="+
$(this).attr("val")}));$("#zayav-info").length&&($(".off").vkHint({msg:"Чтобы удалить эту заявку<br>привяжите её к клиенту.<br>Таким образом все платежи<br>этой заявки вернутся клиенту<br>на баланс после удаления.",ugol:"top",indent:120,top:17,left:426}),$(".zdel").click(function(){var a=_dialog({top:90,width:260,head:"Удаление заявки",content:"<center><b>Подтвердите удаление заявки</b></center>",butSubmit:"Удалить",submit:function(){var c={op:"zayav_del",id:OPL.zayav_id};a.process();$.post(AJAX_GAZ,
c,function(b){b.success?(a.close(),_msg("Заявка удален."),ADMIN?location.reload():location.href=URL+"&p=gazeta&d=client"):a.abort()},"json")}})}),$("#lost-count").click(function(){$(this).parent().find(".lost").show();$(this).remove()}),$(".zinfo").click(function(){$(this).parent().find(".sel").removeClass("sel");$(this).addClass("sel");$("#zayav-info").removeClass("h")}),$(".hist").click(function(){$(this).parent().find(".sel").removeClass("sel");$(this).addClass("sel");$("#zayav-info").addClass("h")}));
if($("#zayav-edit").length){0==$("#client_id").val()&&$("#client_id").clientSel({add:1});window.gnGet=$("#gn_spisok").gnGet({category:ZAYAV.category,gns:ZAYAV.gns,skidka:ZAYAV.skidka,manual:ZAYAV.manual,func:function(){$("#summa").attr("readonly")&&($("#summa").val(window.gnGet.summa()),$("#skidka-txt").html(window.gnGet.skidka()))}});switch(ZAYAV.category){case 1:zayavRubric();zayavRubricSub($("#rubric_id").val());$("#ztxt").autosize().focus().keyup(zayavObSumCalc);zayavObSumCalc();break;case 2:$("#size_x").keyup(zayavRekSumCalc),
$("#size_y").keyup(zayavRekSumCalc),$("#skidka")._select({width:60,title0:"Нет",spisok:SKIDKA_SPISOK,func:function(a){window.gnGet.skidka(a);"0"==$("#summa_manual").val()&&$("#summa").val(window.gnGet.summa());$("#skidka-txt").html(window.gnGet.skidka())}}),window.gnGet.cena(ZAYAV.kv_sm)}3>ZAYAV.category&&$("#summa_manual")._check(function(a){$("#summa").attr("readonly",!a).focus();window.gnGet.manual(a);$("#skidka-txt").html(window.gnGet.skidka())});$("#summa").keyup(function(){window.gnGet.manualSumma($(this).val())});
$(".vkButton").click(function(){function a(a){c.vkHint({msg:"<SPAN class=red>"+a+"</SPAN>",remove:1,indent:40,show:1,top:-58,left:-14})}var c=$(this),b={op:"zayav_edit",zayav_id:ZAYAV.id,client_id:$("#client_id").val(),gns:window.gnGet.result()};1==ZAYAV.category&&(b.rubric_id=$("#rubric_id").val(),b.rubric_sub_id=$("#rubric_sub_id").val(),b.txt=$("#ztxt").val(),b.telefon=$("#telefon").val(),b.adres=$("#adres").val());2==ZAYAV.category&&(b.size_x=$("#size_x").val(),b.size_y=$("#size_y").val(),b.skidka=
$("#skidka").val());3>ZAYAV.category&&(b.summa_manual=$("#summa_manual").val());1==ZAYAV.category&&0==b.rubric_id?a("Не указана рубрика"):1!=ZAYAV.category||b.txt?1!=ZAYAV.category||b.telefon||b.adres?2==ZAYAV.category&&0==b.client_id?a("Не выбран клиент"):2!=ZAYAV.category||REGEXP_CENA.test(b.size_x)&&REGEXP_CENA.test(b.size_y)?"no_polosa"==b.gns?a("Необходимо указать полосы у всех номеров"):REGEXP_CENA.test($("#summa").val())?(c.addClass("busy"),$.post(AJAX_GAZ,b,function(a){a.success?(_msg("Заявка изменена."),
location.href=URL+"&p=gazeta&d=zayav&d1=info&id="+ZAYAV.id):c.removeClass("busy")},"json")):(a("Некорректно введена итоговая стоимость"),$("#summa").focus()):a("Некорректно указан размер блока"):(a("Укажите контактный телефон или адрес клиента"),$("#telefon").focus()):(a("Введите текст объявления"),$("#ztxt").focus())});$(".vkCancel").click(function(){location.href=URL+"&p=gazeta&d=zayav&d1=info&id="+ZAYAV.id})}$("#report.income").length&&(window._calendarFilter=incomeSpisok,$("#income_id")._select({width:160,
title0:"Любые платежи",spisok:INCOME_SPISOK,func:incomeSpisok}),window.WORKERS&&$("#worker_id")._select({width:160,title0:"Все сотрудники",spisok:WORKERS,func:incomeSpisok}));$("#report.expense").length&&($(".add").click(function(){function a(){var a={op:"expense_add",category:1*$("#cat").val(),about:$("#about").val(),worker:$("#work").val(),invoice:1*$("#invoice").val(),sum:$("#sum").val()};a.category||a.about?a.invoice?REGEXP_CENA.test(a.sum)&&0!=a.sum?(d.process(),$.post(AJAX_GAZ,a,function(a){a.success?
(d.close(),_msg("Новый расход внесён."),expenseSpisok()):d.abort()},"json")):(c("Некорректно указана сумма."),$("#sum").focus()):c("Укажите с какого счёта производится оплата."):(c("Выберите категорию или укажите описание."),$("#about").focus())}function c(a){d.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",remove:1,indent:40,show:1,top:-47,left:101})}var b='<table id="expense-add-tab"><tr><td class="label">Категория:<TD><INPUT type="hidden" id="cat"><a href="'+URL+'&p=gazeta&d=setup&d1=expense" class="img_edit'+
_tooltip("Настройка категорий расходов",-95)+'</a><tr class="tr-work dn"><td class="label">Сотрудник:<TD><INPUT type="hidden" id="work"><tr><td class="label">Описание:<TD><INPUT type="text" id="about" maxlength="100"><tr><td class="label">Со счёта:<TD><INPUT type="hidden" id="invoice"><a href="'+URL+'&p=gazeta&d=setup&d1=invoice" class="img_edit'+_tooltip("Настройка счетов",-56)+'</a><tr><td class="label">Сумма:<TD><INPUT type="text" id="sum" class="money" maxlength="11"> руб.</table>',d=_dialog({width:380,
head:"Внесение расхода",content:b,submit:a});$("#cat")._select({width:180,title0:"Не указана",spisok:EXPENSE_SPISOK,func:function(a){$("#work")._select(0);$(".tr-work")[(EXPENSE_WORKER[a]?"remove":"add")+"Class"]("dn")}});$("#about").focus();$("#work")._select({title0:"Не выбран",spisok:WORKER_SPISOK,func:function(){$("#sum").focus()}});$("#invoice")._select({title0:"Не выбран",spisok:INVOICE_SPISOK,func:function(){$("#sum").focus()}});$("#sum,#about").keyEnter(a)}),$("#category")._select({width:160,
title0:"Любая категория",spisok:EXPENSE_SPISOK,func:expenseSpisok}),$("#worker")._select({width:160,title0:"Все сотрудники",spisok:WORKERS,func:expenseSpisok}),$("#invoice_id")._radio({title0:"Любой счёт",light:1,spisok:INVOICE_SPISOK,func:expenseSpisok}),$("#year").years({func:expenseSpisok,center:function(){var a=$("#monthList input"),c=0;for(n=1;12>=n;n++)if(0==a.eq(n-1).val()){c=1;break}for(n=1;12>=n;n++)$("#c"+n)._check(c);expenseSpisok()}}));$("#report.invoice").length&&$(".transfer").click(function(){function a(){var a=
{op:"invoice_transfer",from:1*$("#from").val(),to:1*$("#to").val(),sum:$("#sum").val(),note:$("#note").val()};a.from?a.to?a.from==a.to?c("Выберите другой счёт"):REGEXP_CENA.test(a.sum)&&0!=a.sum?(b.process(),$.post(AJAX_GAZ,a,function(a){a.success?($("#invoice-spisok").html(a.i),$("#transfer-spisok").html(a.t),b.close(),_msg("Перевод произведён.")):b.abort()},"json")):(c("Некорректно введена сумма"),$("#sum").focus()):c("Выберите счёт-получатель"):c("Выберите счёт-отправитель")}function c(a){b.bottom.vkHint({msg:'<span class="red">'+
a+"</span>",top:-47,left:92,indent:50,show:1,remove:1})}$(this);var b=_dialog({width:380,head:"Перевод между счетами",content:'<table class="invoice-transfer"><tr><td class="label">Со счёта:<td><input type="hidden" id="from" /><tr><td class="label">На счёт:<td><input type="hidden" id="to" /><tr><td class="label">Сумма:<td><input type="text" id="sum" class="money" /> руб. <tr><td class="label">Комментарий:<td><input type="text" id="note" /></table>',butSubmit:"Применить",submit:a});$("#from")._select({width:250,
title0:"Не выбран",spisok:INVOICE_SPISOK});$("#to")._select({width:250,title0:"Не выбран",spisok:INVOICE_SPISOK});$("#sum").keyEnter(a)})});
