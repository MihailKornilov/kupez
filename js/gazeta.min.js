var AJAX_GAZ=APP_HTML+"/ajax/gazeta.php?"+VALUES,clientAdd=function(a){function b(){var b={op:"client_add",person:$("#cperson").val(),fio:$("#fio").val(),telefon:$("#ctelefon").val(),org_name:$("#org_name").val(),adres:$("#cadres").val(),inn:$("#inn").val(),kpp:$("#kpp").val(),email:$("#email").val(),skidka:$("#cskidka").val()};0==b.person?c("Не выбрана категория",-48):b.fio||b.org_name?(e.process(),$.post(AJAX_GAZ,b,function(c){c.success?(e.close(),_msg("Новый клиент внесён."),"function"==typeof a?
a(c):document.location.href=URL+"&p=gazeta&d=client&d1=info&id="+c.uid):e.abort()},"json")):c("Необходимо указать контактное лицо<br />либо название организации",-61)}function c(a,c){e.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",top:c,left:131,indent:40,show:1,remove:1})}var d='<table class="client-add"><tr><td class="label">Категория:<td><input type="hidden" id="cperson"><a href="'+URL+'&p=gazeta&d=setup&d1=person" class="img_edit'+_tooltip("Настройка категорий клиентов",-95)+'</a><tr><td class="label">Контактное лицо (фио):<td><input type="text" id="fio" maxlength="200"><tr><td class="label">Название организации:<td><input type="text" id="org_name" maxlength="200"><tr><td class="label">Телефоны:<td><input type="text" id="ctelefon" maxlength="300"><tr><td class="label">Адрес:<td><input type="text" id="cadres" maxlength="200"><tr><td class="label">ИНН:<td><input type="text" id="inn" maxlength="100"><tr><td class="label">КПП:<td><input type="text" id="kpp" maxlength="100"><tr><td class="label">E-mail:<td><input type="text" id="email" maxlength="100"><tr><td class="label">Скидка:<td><input type="hidden" id="cskidka"></table>',
e=_dialog({top:40,width:440,head:"Добавление нoвого клиента",content:d,submit:b});$("#cperson")._select({width:180,title0:"Не выбрана",spisok:PERSON_SPISOK});$("#cskidka")._select({width:60,title0:"Нет",spisok:SKIDKA_SPISOK});$("#fio").focus();$("#fio,#org_name,#ctelefon,#cadres,#inn,#kpp,#email").keyEnter(b)},clientFilter=function(){var a={fast:$("#find")._search("val"),person:$("#person").val(),order:$("#order").val(),skidka:$("#skidka").val(),dolg:$("#dolg").val(),gnyear:$("#gnyear").val(),nomer:$("#nomer").val()};
$(".filter")[a.fast?"hide":"show"]();return a},clientSpisokLoad=function(){var a=clientFilter(),b=$(".result");a.op="client_spisok";b.hasClass("busy")||(b.addClass("busy"),$.post(AJAX_GAZ,a,function(a){b.removeClass("busy");a.success&&(b.html(a.result),$(".left").html(a.spisok))},"json"))},zayavFilter=function(a,b){a={op:"zayav_spisok",find:$("#find")._search("val"),cat:$("#cat").val(),onpay:_num($("#onpay").val()),nopublic:_num($("#nopublic").val()),gnyear:$("#gnyear").val(),nomer:parseInt($("#nomer").val()),
polosa:parseInt($("#polosa").val()),polosa_color:$("#polosa_color").val()};"gnyear"==b&&($("#nomer")._select(0)._select("process"),a.nomer=0);"nomer"!=b&&a.nomer||(zayavPolosa(),$("#polosa")._select(0),a.polosa=0,$("#polosa_color_filter").hide(),$("#polosa_color")._radio(0),a.polosa_color=0);"polosa"==b&&($("#polosa_color")._radio(0),a.polosa_color=0);a.find&&escape(a.find);_cookie("zayav_find",escape(a.find));_cookie("zayav_onpay",a.onpay);_cookie("zayav_cat",a.cat);_cookie("zayav_nopublic",a.nopublic);
_cookie("zayav_gnyear",a.gnyear);_cookie("zayav_nomer",a.nomer);_cookie("zayav_polosa",a.polosa);_cookie("zayav_polosa_color",a.polosa_color);$(".filter")[a.find?"hide":"show"]();$(".filter_nomer")[a.nopublic?"hide":"show"]();$(".filter_onpay")[a.onpay?"hide":"show"]();$("#polosa_filter")[a.nomer?"show":"hide"]();$("#polosa_color_filter")[a.nomer&&1<a.polosa&&a.polosa<GN[a.nomer].pc?"show":"hide"]();return a},zayavSpisok=function(a,b){var c=zayavFilter(a,b);$("#mainLinks").hasClass("busy")||($("#mainLinks").addClass("busy"),
$.post(AJAX_GAZ,c,function(a){$("#mainLinks").removeClass("busy");a.success&&($(".result").html(a.result),$(".left").html(a.spisok),a.gn_sel&&$("#nomer")._select(a.gn_sel),zayavPub())},"json"))},zayavPolosa=function(){if(0!=$("#nomer").val()){for(var a=[{uid:1,title:"Первая"}],b=2;b<GN[$("#nomer").val()].pc;b++)a.push({uid:b,title:b+"-я"});a.push({uid:b,title:"Последняя "+b+"-я"});a.push({uid:103,title:"Внутренняя чёрно-белая"});a.push({uid:104,title:"Внутренняя цветная"});a.push({uid:105,title:"Внутренняя (полоса не указана)"});
$("#polosa")._select({title0:"Любая полоса",spisok:a,func:zayavSpisok})}},zayavPub=function(){var a=$(".topub");if(a.length){for(var b=[],c=2;c<GN[$("#nomer").val()].pc;c++)b.push({uid:c,title:c+"-я"});for(var c=0;c<a.length;c++){var d=a.eq(c),e=d.attr("id"),g=d.val();$("#"+e)._dropdown({spisok:POLOSA_SPISOK,func:function(a,c){zayavPubNomer(b,c,POLOSA_NUM[a],1);var d={op:"zayav_pub",pub_id:c.split("p")[1],dop:a},e=$("#"+c).parent();e.addClass("_busy");$.post(AJAX_GAZ,d,function(a){e.removeClass("_busy")},
"json")}});zayavPubNomer(b,e,POLOSA_NUM[g]);d.removeClass("topub")}}},zayavPubNomer=function(a,b,c,d){c?(d&&$("#n"+b).val(0),$("#n"+b)._dropdown({title0:"??",spisok:a,func:function(a){a={op:"zayav_pub_nomer",pub_id:b.split("p")[1],polosa:a};var c=$("#"+b).parent();c.addClass("_busy");$.post(AJAX_GAZ,a,function(a){c.removeClass("_busy")},"json")}})):$("#n"+b)._dropdown("remove")},zayavRubric=function(){$("#rubric_id")._select({width:120,title0:"Не указана",spisok:RUBRIC_SPISOK,func:function(a){$("#rubric_sub_id").val(0)._select("remove");
zayavRubricSub(a)}})},zayavRubricSub=function(a){RUBRIC_SUB_SPISOK[a]&&$("#rubric_sub_id")._select({width:180,title0:"Подрубрика не указана",spisok:RUBRIC_SUB_SPISOK[a]})},zayavObSumCalc=function(){var a=0,b="",c=$("#ztxt").val().replace(/\./g,"").replace(/,/g,"").replace(/\//g,"").replace(/\"/g,"").replace(/( +)/g," ").replace(/^\s+/g,"").replace(/\s+$/g,"");if(c.length){a+=1*TXT_CENA_FIRST;if(c.length>TXT_LEN_FIRST){var b=" = ",d=Math.ceil((c.length-TXT_LEN_FIRST)/TXT_LEN_NEXT),b=b+TXT_LEN_FIRST,
e=c.length-TXT_LEN_FIRST-(d-1)*TXT_LEN_NEXT,a=a+d*TXT_CENA_NEXT;TXT_LEN_NEXT==e&&d++;1<d&&(b+=" + "+TXT_LEN_NEXT);2<d&&(b+="x"+(d-1));TXT_LEN_NEXT>e&&(b+=" + "+e)}b="Длина: <b>"+c.length+"</b>"+b+"<br />Цена: <b>"+a+"</b> руб.<span>(без учёта доп. параметров)</span>";$("#txt-count").html(b)}else $("#txt-count").html("");window.gnGet.cena(a);"0"==$("#summa_manual").val()&&$("#summa").val(window.gnGet.summa())},zayavRekSumCalc=function(){var a=$(this),b=a.val(),c=a.attr("id"),d=$("#size_x").val(),e=
$("#size_y").val(),d=REGEXP_CENA.test(d)?d.replace(",","."):0,e=REGEXP_CENA.test(e)?e.replace(",","."):0,g=0;$("#kv_sm").val("");REGEXP_CENA.test(b)?(a.prev().remove(".hint"),(g=Math.round(d*e))&&$("#kv_sm").val(g)):a.vkHint({msg:'<span class="red">Не корректно введено значение.</span>',remove:1,indent:40,show:1,top:"size_x"==c?-57:-79,left:"size_x"==c?-33:20});window.gnGet.cena(g);"0"==$("#summa_manual").val()&&$("#summa").val(window.gnGet.summa());$("#skidka-txt").html(window.gnGet.skidka())},incomeSpisok=
function(){var a={op:"income_spisok",day:$(".selected").val(),invoice_id:$("#invoice_id").val(),worker_id:$("#worker_id").val()};$(".inc-path").addClass("_busy");$.post(AJAX_GAZ,a,function(a){$(".inc-path").removeClass("_busy");a.success&&($(".inc-path").html(a.path),$("#spisok").html(a.html))},"json")},expenseFilter=function(){for(var a=[],b=$("#monthList input"),c=1;12>=c;c++)1==b.eq(c-1).val()&&a.push(c);return{op:"expense_spisok",category:$("#category").val(),worker:$("#worker").val(),invoice_id:$("#invoice_id").val(),
year:$("#year").val(),month:a.join()}},expenseSpisok=function(){$("#mainLinks").addClass("busy");$.post(AJAX_GAZ,expenseFilter(),function(a){$("#mainLinks").removeClass("busy");a.success&&($("#spisok").html(a.html),$("#monthList").html(a.mon))},"json")},rz_nomer=function(a,b){if(!$("#mainLinks").hasClass("busy")){var c={op:"report_zayav_nomer",nomer:$("#nomer").val(),year:"gnyear"==b?a:0};$("#mainLinks").addClass("busy");$.post(AJAX_GAZ,c,function(a){$("#mainLinks").removeClass("busy");a.success&&
($("#spisok").html(a.spisok),a.gn_sel&&($("#nomer")._select(a.gn_sel),$("#nomer")._select(a.gn_first)))},"json")}};
$.fn.clientSel=function(a){function b(b){b={op:"client_sel",val:b||"",client_id:a.client_id};c._select("process");$.post(AJAX_GAZ,b,function(b){c._select("cancel");b.success&&(c._select(b.spisok),a.client_id&&(c._select(a.client_id),a.client_id=0))},"json")}var c=$(this);a=$.extend({width:270,add:null,client_id:c.val()||0,func:function(){}},a);a.add&&(a.add=function(){clientAdd(function(a){var b=[];b.push(a);c._select(b);c._select(a.uid)})});c._select({width:a.width,title0:"Начните вводить данные клиента...",
spisok:[],write:1,nofind:"Клиентов не найдено",func:a.func,funcAdd:a.add,funcKeyup:b});b();return c};
$.fn.gnGet=function(a){function b(c,b){c&&(t=GN_FIRST_ACTIVE,r=t+(b||0)+a.show);l.find("#darr").remove();var e="";for(f=t;f<r&&!(f>GN_LAST_ACTIVE);f++){var q=GN[f];q&&(e+='<table><tr><td><table class="gns-week'+(q.sel?" gnsel":"")+(q.prev?" prev":"")+'" val="'+f+'"><tr><td class="td"><b>'+q.week+'</b><span class="g">('+f+')</span><td class="td"><span class="g">выход</span> '+q.txt+'<td class="cena" id="cena'+f+'"></table><td class="vdop"><input type="hidden" id="vdop'+f+'" value="'+q.dop+'" /> <input type="hidden" id="pn'+
f+'" value="'+q.pn+'" /></table>')}e+=r<GN_LAST_ACTIVE?'<div id="darr">&darr; &darr; &darr;</div>':"";w[c?"html":"append"](e);w.animate({height:w.find(".gns-week").length*z+"px"},300);c&&3>a.category&&d(function(c){$("#vdop"+c.n)._dropdown({title0:1==a.category?"Доп. параметр не указан":"Полоса не указана",spisok:1==a.category?OBDOP_SPISOK:POLOSA_SPISOK,func:function(b){GN[c.n].dop=b;h();a.func();if(2==a.category&&(GN[c.n].pn=0,$("#pn"+c.n).val(0)._dropdown("remove"),POLOSA_NUM[b])){b=[];for(d=2;d<
GN[c.n].pc;d++)b.push({uid:d,title:d+"-я"});$("#pn"+c.n)._dropdown({title0:"??",spisok:b,func:function(a){GN[c.n].pn=a}})}}});if(2==a.category&&POLOSA_NUM[c.dop]){for(var b=[],d=2;d<GN[c.n].pc;d++)b.push({uid:d,title:d+"-я"});$("#pn"+c.n)._dropdown({title0:"??",spisok:b,func:function(a){GN[c.n].pn=a}})}});h()}function c(){A._dropdown(2<a.category?"remove":{head:"Установить всем...",headgrey:1,title0:1==a.category?"Доп. параметр не указан":"Полоса не указана",nosel:1,spisok:1==a.category?OBDOP_SPISOK:
POLOSA_SPISOK,func:function(c){d(function(b){if(!b.prev&&($("#vdop"+b.n)._dropdown(c),b.dop=c,2==a.category)){b.pn=0;if(POLOSA_NUM[c])for(var d=[],e=2;e<GN[b.n].pc;e++)d.push({uid:e,title:e+"-я"});$("#pn"+b.n).val(0)._dropdown(POLOSA_NUM[c]?{title0:"??",spisok:d,func:function(a){GN[b.n].pn=a}}:"remove")}});h();a.func()}})}function d(a,c){for(var b=GN_FIRST_ACTIVE;b<=GN_LAST_ACTIVE;b++){var d=GN[b];d&&(c||d.sel)&&a(d,b)}}function e(){var c=0;d(function(){c++});if(c){var e="Выбран"+_end(c,["","о"])+
" "+c+" номер"+_end(c,["","a","ов"])+"<a>очистить</a>";x.html(e).find("a").click(function(){g();b(1);x.html("");u.removeClass("sel");a.func()})}else x.html("")}function g(){d(function(a,c){a.n=c;a.sel=0;a.prev=0;a.cena=0;a.dop=0;a.pn=0},1)}function h(){var c=0,b=0;switch(a.category){case 1:var e=0;a.manual&&(d(function(a){a.prev||(e++,4==e?e=0:b++)}),e=0,c=Math.round(s/b*1E6)/1E6);d(function(b){b.prev||(e++,4==e?(e=0,b.cena=0):b.cena=a.manual?c:v?v+(b.dop?OBDOP_CENA_ASS[b.dop]:0):0);l.find("#cena"+
b.n).html(Math.round(100*b.cena)/100)});break;case 2:a.manual&&(d(function(a){0<a.dop&&!a.prev&&b++}),c=Math.round(s/b*1E6)/1E6);m=0;d(function(b){if(!b.prev&&(b.cena=0,b.dop))if(a.manual)b.cena=c;else{b.cena=v*POLOSA_CENA_ASS[b.dop];var d=b.cena*a.skidka/100;b.cena-=d;m+=d}l.find("#cena"+b.n).html(Math.round(100*b.cena)/100)});m=Math.round(100*m)/100;break;default:d(function(a){a.prev||b++}),c=Math.round(s/b*1E6)/1E6,d(function(a){a.prev||(a.cena=c);l.find("#cena"+a.n).html(Math.round(100*a.cena)/
100)})}}function y(){var a=0;d(function(b){b.prev||(a+=b.cena)});return Math.round(100*a)/100}a=$.extend({show:4,add:8,category:1,gns:null,skidka:0,manual:0,func:function(){}},a);var k=$(this),z=21,t=GN_FIRST_ACTIVE,r=t+a.show;k.html('<div id="gnGet"><table><tr><td><div id="dopLinks"><a class="link" val="4">Месяц</a><a class="link" val="13">3 месяца</a><a class="link" val="26">Полгода</a><a class="link" val="52">Год</a></div><td><input type="hidden" id="dopDef"></table><table class="gn-spisok"><tr><td id="selCount"><td><div id="gns"></div></table></div>');
$(document).on("click","#darr",function(){t=r;r+=a.add;b()}).on("click",".gns-week",function(){u.removeClass("sel");var b=$(this),c=!b.hasClass("gnsel"),d=b.attr("val");b[(c?"add":"remove")+"Class"]("gnsel");b.removeClass("prev");GN[d].prev=0;GN[d].sel=c;GN[d].dop=0;GN[d].pn=0;3>a.category&&(2==a.category&&$("#pn"+d).val(0)._dropdown("remove"),$("#vdop"+d).val(0)._dropdown(c?{title0:1==a.category?"Доп. параметр не указан":"Полоса не указана",spisok:1==a.category?OBDOP_SPISOK:POLOSA_SPISOK,func:function(b){GN[d].dop=
b;h();a.func();if(2==a.category&&(GN[d].pn=0,$("#pn"+d).val(0)._dropdown("remove"),POLOSA_NUM[b])){b=[];for(f=2;f<GN[d].pc;f++)b.push({uid:f,title:f+"-я"});$("#pn"+d)._dropdown({title0:"??",spisok:b,func:function(a){GN[d].pn=a}})}}}:"remove"));e();h();a.func()});var l=$("#gnGet"),w=l.find("#gns"),u=l.find("#dopLinks a"),A=l.find("#dopDef"),x=l.find("#selCount"),v=0,s=0,m=0;g();if(a.gns){var p=0,f;for(f in a.gns){if(f>GN_LAST_ACTIVE)break;GN[f]&&(p=GN[f],p.sel=1,p.prev=1,p.cena=a.gns[f][0],p.dop=a.gns[f][1],
p.pn=a.gns[f][2],p=f)}b(1,p-GN_FIRST_ACTIVE+1);e()}else b();c();u.click(function(){var c=$(this),d=1*c.attr("val");g();if(c.hasClass("sel"))d=0,c.removeClass("sel");else for(u.removeClass("sel"),c.addClass("sel"),f=GN_FIRST_ACTIVE,c=d;c&&!(f>GN_LAST_ACTIVE);)GN[f]&&(GN[f].sel=1,c--,f++);e();b(1,d);a.func()});k.cena=function(a){v=a||0;h()};k.skidka=function(b){return void 0!=b?(a.skidka=b,h(),""):2==a.category&&m?"Сумма скидки: <b>"+m+"</b> руб.":""};k.summa=y;k.clear=function(d){a.category=d;a.manual=
0;s=m=a.skidka=0;u.removeClass("sel");g();b(1);c()};k.manual=function(b,c){a.manual=b;s=y();h();a.func()};k.manualSumma=function(a){s=REGEXP_CENA.test(a)?1*a.replace(",","."):0;h()};k.result=function(){var b=[],c=0;d(function(d){2!=a.category||d.dop||(c=1);b.push(d.n+":"+d.cena+":"+d.dop+":"+d.pn)});return c?"no_polosa":b.join()};return k};
$(document).on("click","#client ._next",function(){if(!$(this).hasClass("busy")){var a=$(this),b=clientFilter();b.op="client_next";b.page=a.attr("val");a.addClass("busy");$.post(AJAX_GAZ,b,function(b){b.success?(a.remove(),$("#client .left").append(b.spisok)):a.removeClass("busy")},"json")}}).on("click","#zayav ._next",function(){var a=$(this),b=zayavFilter();b.page=a.attr("val");a.hasClass("busy")||(a.addClass("busy"),$.post(AJAX_GAZ,b,function(b){b.success?(a.after(b.spisok).remove(),zayavPub()):
a.removeClass("busy")},"json"))}).on("click","#zayav .clear",function(){$("#find")._search("clear");$("#cat").rightLink(0);$("#onpay")._check(0);$("#nopublic")._check(0);$("#nomer")._select(GN_FIRST_ACTIVE);$("#polosa")._select(0);$("#polosa_color")._check(0);zayavSpisok()}).on("click",".income-add",function(){function a(){var a={op:"income_add",from:OPL.from,invoice_id:$("#invoice_id_add").val(),sum:$("#sum").val(),zayav_id:OPL.zayav_id||0,client_id:OPL.client_id||0,prim:$.trim($("#prim").val())};
0==a.invoice_id?b("Не указан счёт"):REGEXP_CENA.test(a.sum)&&0!=a.sum?a.zayav_id||a.prim?(d.process(),$.post(AJAX_GAZ,a,function(a){if(a.success)switch(d.close(),_msg("Платёж успешно внесён!"),OPL.from){case "client":$("#income_spisok").html(a.html);$(".left:first").html(a.balans);break;case "zayav":$("#income_spisok").html(a.html);$(".zdel").remove();break;case "income":incomeSpisok()}else d.abort()},"json")):(b("Необходимо указать комментарий"),$("#prim").focus()):(b("Некорректно указана сумма."),
$("#sum").focus())}function b(a){d.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",remove:1,indent:40,show:1,top:-48,left:115})}var c='<table class="income-add-tab">'+(OPL.client_fio?'<tr><td class="label">Клиент:<td>'+OPL.client_fio:"")+(OPL.zayav_name?'<tr><td class="label">Заявка:<td><b>'+OPL.zayav_name+"</b>":"")+'<tr><td class="label">На счёт:<td><input type="hidden" id="invoice_id_add"><a href="'+URL+'&p=gazeta&d=setup&d1=invoice" class="img_edit'+_tooltip("Настройка счетов",-57)+'</a><tr><td class="label">Сумма:<td><input type="text" id="sum" class="money" maxlength="11"> руб.<tr><td class="label">Комментарий:<td><input type="text" id="prim" maxlength="100"></table>',
d=_dialog({width:400,head:"Внесение платежа",content:c,submit:a});$("#sum").focus();$("#sum,#prim").keyEnter(a);$("#invoice_id_add")._select({width:180,title0:"Не указан",spisok:INVOICE_SPISOK,func:function(a){$("#sum").focus()}})}).on("click",".income-del",function(){for(var a=$(this),b=_dialog({width:300,head:"Удаление платежа",content:"<center><b>Подтвердите удаление платежа.</b></center>",butSubmit:"Удалить",submit:function(){var c={op:"income_del",id:a.attr("val")};b.process();$.post(AJAX_GAZ,
c,function(c){c.success?(a.remove(),b.close(),_msg("Платёж удалён")):b.abort()},"json")}});"TR"!=a[0].tagName;)a=a.parent()}).on("click","#income_next",function(){var a=$(this),b={op:"income_spisok",page:$(this).attr("val"),limit:$("#money_limit").val(),client_id:$("#money_client_id").val(),zayav_id:$("#money_zayav_id").val(),deleted:$("#money_deleted").val(),invoice_id:$("#money_invoice_id").val(),worker_id:$("#money_worker_id").val(),day:$(".selected").val()||""};a.hasClass("busy")||(a.addClass("busy"),
$.post(AJAX_GAZ,b,function(b){b.success?a.after(b.html).remove():a.removeClass("busy")},"json"))}).on("click",".expense #monthList div",expenseSpisok).on("click",".expense ._next",function(){var a=$(this),b=expenseFilter();b.page=a.attr("val");a.hasClass("busy")||(a.addClass("busy"),$.post(AJAX_GAZ,b,function(b){b.success?a.after(b.html).remove():a.removeClass("busy")},"json"))}).on("click",".expense .img_del",function(){for(var a=$(this),b=_dialog({width:300,head:"Удаление расхода",content:"<center><b>Подтвердите удаление расхода.</b></center>",
butSubmit:"Удалить",submit:function(){var c={op:"expense_del",id:a.attr("val")};b.process();$.post(AJAX_GAZ,c,function(c){c.success?(a.remove(),b.close(),_msg("Расход удалён")):b.abort()},"json")}});"TR"!=a[0].tagName;)a=a.parent()}).on("click",".invoice_set",function(){function a(){var a={op:"invoice_set",invoice_id:b,sum:$("#sum").val()};REGEXP_CENA.test(a.sum)?(c.process(),$.post(AJAX_GAZ,a,function(a){a.success?($("#invoice-spisok").html(a.i),c.close(),_msg("Баланс установлен.")):c.abort()},"json")):
(c.bottom.vkHint({msg:'<SPAN class="red">Некорректно указана сумма</SPAN>',remove:1,indent:40,show:1,top:-48,left:72}),$("#sum").focus())}var b=$(this).attr("val"),c=_dialog({width:320,head:"Установка текущей суммы счёта",content:'<table class="_dialog-tab"><tr><td class="label">Сумма:<td><input type="text" class="money" id="sum" maxlength="11"> руб.</table>',butSubmit:"Установить",submit:a});$("#sum").focus().keyEnter(a)}).on("click","#report.invoice .img_note",function(){var a=_dialog({top:20,width:570,
head:"История операций со счётом",load:1,butSubmit:"",butCancel:"Закрыть"}),b={op:"invoice_history",invoice_id:$(this).attr("val")};$.post(AJAX_GAZ,b,function(b){b.success?a.content.html(b.html):a.loadError()},"json")}).on("click","#history_next",function(){if(!$(this).hasClass("busy")){var a=$(this),b={op:"history_next",page:a.attr("val")};a.addClass("busy");$.post(AJAX_GAZ,b,function(b){b.success?a.after(b.html).remove():a.removeClass("busy")},"json")}}).ready(function(){$("#client").length&&($("#find")._search({width:602,
focus:1,enter:1,txt:"Введите данные клиента и нажмите Enter",func:clientSpisokLoad}),$("#buttonCreate").click(clientAdd),$("#order")._radio({light:1,spisok:[{uid:1,title:"По дате добавления"},{uid:2,title:"По активности"}],func:clientSpisokLoad}),$("#order_radio").vkHint({width:210,msg:'<div style="text-align:justify"><b>По дате добавления:</b><br> клиенты, добавленные последними, стоят в списке первыми.<br><br><b>По активности:</b><br> сортировка по дате выхода последней заявки клиента. Также показывается дополнительное поле "Активность", в котором содержится дата последнего выхода заявки.</div>',
ugol:"right",indent:15,top:-34,left:-246,delayShow:1E3}),$("#person")._select({spisok:PERSON_SPISOK,title0:"Категория не выбрана",func:clientSpisokLoad}),$("#skidka")._select({spisok:SKIDKA_SPISOK,title0:"Скидка не выбрана",func:clientSpisokLoad}),$("#dolg")._check(clientSpisokLoad),$("#dolg_check").vkHint({msg:"<b>Список должников.</b><br /><br />Выводятся клиенты, у которых баланс менее 0. Также в результате отображается общая сумма долга.",ugol:"right",width:150,top:-6,left:-185,indent:20,delayShow:1E3,
correct:0}),$("#gnyear")._select({title0:"Год не указан",spisok:GN_YEAR,func:function(a){$("#nomer").val(0);a?($("#nomer")._select({title0:"Номер не указан",spisok:[],func:clientSpisokLoad}),$("#nomer")._select("process"),$.post(AJAX_GAZ,{op:"gn_spisok_load",year:a},function(a){a.success&&$("#nomer")._select(a.gn_sel)},"json")):$("#nomer")._select("remove");clientSpisokLoad()}}));$("#clientInfo").length&&($(".cedit").click(function(){function a(){var a={op:"client_edit",id:CLIENT.id,person:$("#cperson").val(),
fio:$("#fio").val(),telefon:$("#telefon").val(),org_name:$("#org_name").val(),adres:$("#adres").val(),inn:$("#inn").val(),kpp:$("#kpp").val(),email:$("#email").val(),skidka:$("#cskidka").val()};a.fio||a.org_name?(c.process(),$.post(AJAX_GAZ,a,function(a){a.success?(CLIENT=a,$("#clientInfo .left:first").html(a.html),c.close(),_msg("Данные изменены.")):c.abort()},"json")):c.bottom.vkHint({msg:'<SPAN class="red">Необходимо указать контактное лицо<br />либо название организации</SPAN>',top:-61,left:131,
indent:40,show:1,remove:1})}var b='<table class="client-add"><tr><td class="label">Категория:<td><input type="hidden" id="cperson" value="'+CLIENT.person+'" /><a href="'+URL+'&p=gazeta&d=setup&d1=person" class="img_edit'+_tooltip("Настройка категорий клиентов",-95)+'</a><tr><td class="label">Контактное лицо (фио):<td><input type="text" id="fio" maxlength="200" value="'+CLIENT.fio+'" /><tr><td class="label">Название организации:<td><input type="text" id="org_name" maxlength="200" value="'+CLIENT.org_name+
'" /><tr><td class="label">Телефоны:<td><input type="text" id="telefon" maxlength="300" value="'+CLIENT.telefon+'" /><tr><td class="label">Адрес:<td><input type="text" id="adres" maxlength="200" value="'+CLIENT.adres+'" /><tr><td class="label">ИНН:<td><input type="text" id="inn" maxlength="100" value="'+CLIENT.inn+'" /><tr><td class="label">КПП:<td><input type="text" id="kpp" maxlength="100" value="'+CLIENT.kpp+'" /><tr><td class="label">E-mail:<td><input type="text" id="email" maxlength="100" value="'+
CLIENT.email+'" /><tr><td class="label">Скидка:<td><input type="hidden" id="cskidka" value="'+CLIENT.skidka+'" /></table>',c=_dialog({top:40,width:440,head:"Редактирование данных клиента",content:b,butSubmit:"Сохранить",submit:a});$("#cperson")._select({width:180,spisok:PERSON_SPISOK});$("#cskidka")._select({width:60,title0:"Нет",spisok:SKIDKA_SPISOK});$("#fio").focus();$("#fio,#org_name,#telefon,#adres,#inn,#kpp,#email").keyEnter(a)}),$(".rightLink .off").vkHint({width:130,msg:"Клиента можно удалить, если у него нет ни одной заявки",
ugol:"right",delayShow:700,top:-17,left:-164}),$(".cdel").click(function(){var a=_dialog({top:90,width:300,head:"Удаление клиента",content:"<center>Внимание!<br />Будут удалены все данные о клиенте,<br />его платежи и заметки.<br /><b>Подтвердите удаление.</b></center>",butSubmit:"Удалить",submit:function(){var b={op:"client_del",id:CLIENT.id};a.process();$.post(AJAX_GAZ,b,function(b){b.success?(a.close(),_msg("Клиент удален."),ADMIN?location.reload():location.href=URL+"&p=gazeta&d=client"):a.abort()},
"json")}})}),$("#dopLinks .link").click(function(){$("#dopLinks .link").removeClass("sel");$(this).addClass("sel");var a=$(this).attr("val");$("#zayav_spisok").css("display","zayav"==a?"block":"none");$("#income_spisok").css("display","inc"==a?"block":"none");$("#notes").css("display","note"==a?"block":"none");$("#histories").css("display","hist"==a?"block":"none")}));$("#zayav").length&&($("#find").vkHint({width:145,msg:'<div style="text-align:justify">Введите значение и нажмите <b>Enter</b>. Поиск производится по всем объявлениям, то есть другие параметры не учитываются. Если указано число и оно совпадает с номером заявки, то эта заявка выводится первая в списке.<div>',
ugol:"right",indent:10,top:-1,left:-182,delayShow:1500})._search({width:148,focus:1,enter:1,txt:"Быстрый поиск..",func:zayavSpisok}).inp(Z.find),$("#onpay")._check(zayavSpisok),$("#cat").rightLink(zayavSpisok),$(".img_word").click(function(){var a=$("#nomer").val();0==a?$(this).vkHint({width:150,ugol:"right",msg:"<span class=red>Не выбран номер газеты.</span>",indent:5,top:-26,left:-198,show:1,remove:1}):location.href=APP_HTML+"/view/ob-word.php?"+VALUES+"&gn="+a;return!1}).vkHint({ugol:"right",width:145,
msg:'<span style="color:#444">Открыть список объявлений в газетном варианте в формате Microsoft Word.</span>',indent:10,top:-30,left:-193}),$("#nopublic")._check(zayavSpisok),$("#nopublic_check").vkHint({width:145,msg:"Заявки, которые не публиковались ни в одном номере газеты.",indent:60,top:-64,left:-61}),$("#gnyear").years({center:zayavSpisok,func:zayavSpisok}),$("#nomer")._select({title0:"Номер не указан",spisok:GN_SEL,func:zayavSpisok}),zayavPolosa(),$("#polosa_color")._radio(zayavSpisok),zayavPub());
$("#zayav-add").length&&($("#client_id").clientSel({add:1,func:function(a,b,c){ZA.skidka=a?c.skidka:"";$("#skidka")._select(ZA.skidka);window.gnGet.skidka(ZA.skidka);"0"==$("#summa_manual").val()&&$("#summa").val(window.gnGet.summa());$("#skidka-txt").html(window.gnGet.skidka())}}),$("#category")._select({width:120,spisok:CATEGORY_SPISOK,func:function(a){$(".ob").addClass("dn");$("#rubric_id").val(0)._select("remove");$("#rubric_sub_id").val(0)._select("remove");$("#ztxt").val("");zayavObSumCalc();
$("#telefon").val("");$("#adres").val("");$("#summa_manual")._check(0);$(".rek").addClass("dn");$("#size_x").val("");$("#size_y").val("");$("#kv_sm").val("");$(".skd").addClass("dn");$("#skidka")._select(ZA.skidka);$("#skidka-txt").html("");$(".manual").addClass("dn");$("#summa").attr("readonly",!0).val(0);window.gnGet.clear(a);switch(a){case 1:$(".ob").removeClass("dn");$(".manual").removeClass("dn");zayavRubric();break;case 2:$(".rek").removeClass("dn");$(".skd").removeClass("dn");$(".manual").removeClass("dn");
window.gnGet.skidka(ZA.skidka);break;default:$("#summa").attr("readonly",!1)}}}),zayavRubric(),$("#ztxt").autosize().focus().keyup(zayavObSumCalc),$("#size_x").keyup(zayavRekSumCalc),$("#size_y").keyup(zayavRekSumCalc),window.gnGet=$("#gn_spisok").gnGet({func:function(){$("#summa").attr("readonly")&&($("#summa").val(window.gnGet.summa()),$("#skidka-txt").html(window.gnGet.skidka()))}}),$("#skidka")._select({width:60,title0:"Нет",spisok:SKIDKA_SPISOK,func:function(a){window.gnGet.skidka(a);"0"==$("#summa_manual").val()&&
$("#summa").val(window.gnGet.summa());$("#skidka-txt").html(window.gnGet.skidka())}}),$("#summa_manual")._check(function(a){$("#summa").attr("readonly",!a).focus();window.gnGet.manual(a);$("#skidka-txt").html(window.gnGet.skidka())}),$("#summa").keyup(function(){window.gnGet.manualSumma($(this).val())}),$("#note").autosize(),$(".vkButton").click(function(){function a(a){b.vkHint({msg:"<SPAN class=red>"+a+"</SPAN>",remove:1,indent:40,show:1,top:-58,left:-14})}var b=$(this),c={op:"zayav_add",client_id:$("#client_id").val(),
category:$("#category").val(),rubric_id:$("#rubric_id").val(),rubric_sub_id:$("#rubric_sub_id").val(),txt:$("#ztxt").val(),telefon:$("#telefon").val(),adres:$("#adres").val(),size_x:$("#size_x").val(),size_y:$("#size_y").val(),gns:window.gnGet.result(),skidka:$("#skidka").val(),summa_manual:$("#summa_manual").val(),note:$("#note").val()};1==c.category&&0==c.rubric_id?a("Не указана рубрика"):1!=c.category||c.txt?1!=c.category||c.telefon||c.adres?2==c.category&&0==c.client_id?a("Не выбран клиент"):
2!=c.category||REGEXP_CENA.test(c.size_x)&&REGEXP_CENA.test(c.size_y)?c.gns?"no_polosa"==c.gns?a("Необходимо указать полосы у всех номеров"):REGEXP_CENA.test($("#summa").val())?(b.addClass("busy"),$.post(AJAX_GAZ,c,function(a){a.success?(_msg("Заявка внесена."),location.href=URL+"&p=gazeta&d=zayav&d1=info&id="+a.id):b.removeClass("busy")},"json")):(a("Некорректно введена итоговая стоимость"),$("#summa").focus()):a("Нужно выбрать хотя бы один номер выпуска"):a("Некорректно указан размер блока"):(a("Укажите контактный телефон или адрес клиента"),
$("#telefon").focus()):(a("Введите текст объявления"),$("#ztxt").focus())}),$(".vkCancel").click(function(){location.href=URL+"&p=gazeta&d="+ZA.back}));$("#zayav-info").length&&($(".off").vkHint({msg:"Чтобы удалить эту заявку<br>привяжите её к клиенту.<br>Таким образом все платежи<br>этой заявки вернутся клиенту<br>на баланс после удаления.",ugol:"top",indent:120,top:17,left:426}),$(".zdel").click(function(){var a=_dialog({top:90,width:260,head:"Удаление заявки",content:"<center><b>Подтвердите удаление заявки</b></center>",
butSubmit:"Удалить",submit:function(){var b={op:"zayav_del",id:OPL.zayav_id};a.process();$.post(AJAX_GAZ,b,function(b){b.success?(a.close(),_msg("Заявка удален."),ADMIN?location.reload():location.href=URL+"&p=gazeta&d=client"):a.abort()},"json")}})}),$("#onpay-checked").click(function(){var a=_dialog({head:"Проверка интернет-объявления",content:"<div>Прежде чем разрешить публикацию объявления, проверьте следующие параметры:<br /><br />1. Объявление не должно содержать ошибок.<br />2. Объявление должно выполнять условия размещения.<br />3. Должен быть зачислен платёж от Onpay.</div>",
butSubmit:"Разрешить",submit:function(){var b={op:"zayav_onpay_checked",id:OPL.zayav_id};a.process();$.post(AJAX_GAZ,b,function(b){b.success?(a.close(),_msg("Объявление проверено"),location.reload()):a.abort()},"json")}})}),$("#lost-count").click(function(){$(this).parent().find(".lost").show();$(this).remove()}),$(".zinfo").click(function(){$(this).parent().find(".sel").removeClass("sel");$(this).addClass("sel");$("#zayav-info").removeClass("h")}),$(".hist").click(function(){$(this).parent().find(".sel").removeClass("sel");
$(this).addClass("sel");$("#zayav-info").addClass("h")}));if($("#zayav-edit").length){0==$("#client_id").val()&&$("#client_id").clientSel({add:1});window.gnGet=$("#gn_spisok").gnGet({category:ZAYAV.category,gns:ZAYAV.gns,skidka:ZAYAV.skidka,manual:ZAYAV.manual,func:function(){$("#summa").attr("readonly")&&($("#summa").val(window.gnGet.summa()),$("#skidka-txt").html(window.gnGet.skidka()))}});switch(ZAYAV.category){case 1:zayavRubric();zayavRubricSub($("#rubric_id").val());$("#ztxt").autosize().focus().keyup(zayavObSumCalc);
zayavObSumCalc();break;case 2:$("#size_x").keyup(zayavRekSumCalc),$("#size_y").keyup(zayavRekSumCalc),$("#skidka")._select({width:60,title0:"Нет",spisok:SKIDKA_SPISOK,func:function(a){window.gnGet.skidka(a);"0"==$("#summa_manual").val()&&$("#summa").val(window.gnGet.summa());$("#skidka-txt").html(window.gnGet.skidka())}}),window.gnGet.cena(ZAYAV.kv_sm)}3>ZAYAV.category&&$("#summa_manual")._check(function(a){$("#summa").attr("readonly",!a).focus();window.gnGet.manual(a);$("#skidka-txt").html(window.gnGet.skidka())});
$("#summa").keyup(function(){window.gnGet.manualSumma($(this).val())});$(".vkButton").click(function(){function a(a){b.vkHint({msg:"<SPAN class=red>"+a+"</SPAN>",remove:1,indent:40,show:1,top:-58,left:-14})}var b=$(this),c={op:"zayav_edit",zayav_id:ZAYAV.id,client_id:$("#client_id").val(),gns:window.gnGet.result()};1==ZAYAV.category&&(c.rubric_id=$("#rubric_id").val(),c.rubric_sub_id=$("#rubric_sub_id").val(),c.txt=$("#ztxt").val(),c.telefon=$("#telefon").val(),c.adres=$("#adres").val());2==ZAYAV.category&&
(c.size_x=$("#size_x").val(),c.size_y=$("#size_y").val(),c.skidka=$("#skidka").val());3>ZAYAV.category&&(c.summa_manual=$("#summa_manual").val());1==ZAYAV.category&&0==c.rubric_id?a("Не указана рубрика"):1!=ZAYAV.category||c.txt?1!=ZAYAV.category||c.telefon||c.adres?2==ZAYAV.category&&0==c.client_id?a("Не выбран клиент"):2!=ZAYAV.category||REGEXP_CENA.test(c.size_x)&&REGEXP_CENA.test(c.size_y)?"no_polosa"==c.gns?a("Необходимо указать полосы у всех номеров"):REGEXP_CENA.test($("#summa").val())?(b.addClass("busy"),
$.post(AJAX_GAZ,c,function(a){a.success?(_msg("Заявка изменена."),location.href=URL+"&p=gazeta&d=zayav&d1=info&id="+ZAYAV.id):b.removeClass("busy")},"json")):(a("Некорректно введена итоговая стоимость"),$("#summa").focus()):a("Некорректно указан размер блока"):(a("Укажите контактный телефон или адрес клиента"),$("#telefon").focus()):(a("Введите текст объявления"),$("#ztxt").focus())});$(".vkCancel").click(function(){location.href=URL+"&p=gazeta&d=zayav&d1=info&id="+ZAYAV.id})}$("#report.income").length&&
(window._calendarFilter=incomeSpisok,$("#invoice_id")._select({width:160,title0:"Любой счёт",spisok:INVOICE_SPISOK,func:incomeSpisok}),window.WORKERS&&$("#worker_id")._select({width:160,title0:"Все сотрудники",spisok:WORKERS,func:incomeSpisok}));$("#report.expense").length&&($(".add").click(function(){function a(){var a={op:"expense_add",category:1*$("#cat").val(),about:$("#about").val(),worker:$("#work").val(),invoice:1*$("#invoice").val(),sum:$("#sum").val()};a.category||a.about?a.invoice?REGEXP_CENA.test(a.sum)&&
0!=a.sum?(d.process(),$.post(AJAX_GAZ,a,function(a){a.success?(d.close(),_msg("Новый расход внесён."),expenseSpisok()):d.abort()},"json")):(b("Некорректно указана сумма."),$("#sum").focus()):b("Укажите с какого счёта производится оплата."):(b("Выберите категорию или укажите описание."),$("#about").focus())}function b(a){d.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",remove:1,indent:40,show:1,top:-47,left:101})}var c='<table id="expense-add-tab"><tr><td class="label">Категория:<TD><INPUT type="hidden" id="cat"><a href="'+
URL+'&p=gazeta&d=setup&d1=expense" class="img_edit'+_tooltip("Настройка категорий расходов",-95)+'</a><tr class="tr-work dn"><td class="label">Сотрудник:<TD><INPUT type="hidden" id="work"><tr><td class="label">Описание:<TD><INPUT type="text" id="about" maxlength="100"><tr><td class="label">Со счёта:<TD><INPUT type="hidden" id="invoice"><a href="'+URL+'&p=gazeta&d=setup&d1=invoice" class="img_edit'+_tooltip("Настройка счетов",-56)+'</a><tr><td class="label">Сумма:<TD><INPUT type="text" id="sum" class="money" maxlength="11"> руб.</table>',
d=_dialog({width:380,head:"Внесение расхода",content:c,submit:a});$("#cat")._select({width:180,title0:"Не указана",spisok:EXPENSE_SPISOK,func:function(a){$("#work")._select(0);$(".tr-work")[(EXPENSE_WORKER[a]?"remove":"add")+"Class"]("dn")}});$("#about").focus();$("#work")._select({title0:"Не выбран",spisok:WORKER_SPISOK,func:function(){$("#sum").focus()}});$("#invoice")._select({title0:"Не выбран",spisok:INVOICE_SPISOK,func:function(){$("#sum").focus()}});$("#sum,#about").keyEnter(a)}),$("#category")._select({width:160,
title0:"Любая категория",spisok:EXPENSE_SPISOK,func:expenseSpisok}),$("#worker")._select({width:160,title0:"Все сотрудники",spisok:WORKERS,func:expenseSpisok}),$("#invoice_id")._radio({title0:"Любой счёт",light:1,spisok:INVOICE_SPISOK,func:expenseSpisok}),$("#year").years({func:expenseSpisok,center:function(){var a=$("#monthList input"),b=0;for(n=1;12>=n;n++)if(0==a.eq(n-1).val()){b=1;break}for(n=1;12>=n;n++)$("#c"+n)._check(b);expenseSpisok()}}));$("#report.invoice").length&&$(".transfer").click(function(){function a(){var a=
{op:"invoice_transfer",from:1*$("#from").val(),to:1*$("#to").val(),sum:$("#sum").val(),note:$("#note").val()};a.from?a.to?a.from==a.to?b("Выберите другой счёт"):REGEXP_CENA.test(a.sum)&&0!=a.sum?(c.process(),$.post(AJAX_GAZ,a,function(a){a.success?($("#invoice-spisok").html(a.i),$("#transfer-spisok").html(a.t),c.close(),_msg("Перевод произведён.")):c.abort()},"json")):(b("Некорректно введена сумма"),$("#sum").focus()):b("Выберите счёт-получатель"):b("Выберите счёт-отправитель")}function b(a){c.bottom.vkHint({msg:'<span class="red">'+
a+"</span>",top:-47,left:92,indent:50,show:1,remove:1})}$(this);var c=_dialog({width:380,head:"Перевод между счетами",content:'<table class="invoice-transfer"><tr><td class="label">Со счёта:<td><input type="hidden" id="from" /><tr><td class="label">На счёт:<td><input type="hidden" id="to" /><tr><td class="label">Сумма:<td><input type="text" id="sum" class="money" /> руб. <tr><td class="label">Комментарий:<td><input type="text" id="note" /></table>',butSubmit:"Применить",submit:a});$("#from")._select({width:250,
title0:"Не выбран",spisok:INVOICE_SPISOK});$("#to")._select({width:250,title0:"Не выбран",spisok:INVOICE_SPISOK});$("#sum").keyEnter(a)});$("#report.zayav").length&&($("#gnyear").years({func:rz_nomer}),$("#nomer")._select({width:160,spisok:GN_SEL,func:rz_nomer}))});
